import { useEffect, useMemo, useRef, useState } from "react";
import { toast } from "react-toastify";
import { ë°”ë‘‘íŒ_ê¸¸ì´ } from "../constant";
import { createë°”ë‘‘íŒ } from "../logic/createë°”ë‘‘íŒ";
import { getê²Œì„_ìŠ¹ì } from "../logic/getê²Œì„_ìŠ¹ì";
import type { ë°”ë‘‘ì•Œ } from "../types";
import useColorTurnUser from "./useColorTurnUser";

function useColorTurn() {
  const $ë†“ì„_ëŒ = useRef<"ê°€ì§„_ëŒ" | "ë†“ì¸_ëŒ">();

  const $ì˜®ê¸¸_ëŒ = useRef<[number, number]>();

  const $ê²Œì„_ìŠ¹ì = useRef<ë°”ë‘‘ì•Œ>();

  const [ì°¨ë¡€, setì°¨ë¡€] = useState<"í‘ëŒ" | "ë°±ëŒ">("í‘ëŒ");

  const [ë†“ì„_ìˆ˜_ìˆëŠ”_ìœ„ì¹˜, setë†“ì„_ìˆ˜_ìˆëŠ”_ìœ„ì¹˜] = useState<
    Array<[number, number]>
  >([]);

  const [ë§ˆì§€ë§‰ìœ¼ë¡œ_ë†“ì¸_ëŒ_ìœ„ì¹˜, setë§ˆì§€ë§‰ìœ¼ë¡œ_ë†“ì¸_ëŒ_ìœ„ì¹˜] =
    useState<[number, number]>();

  const [isê²Œì„_ì¢…ë£Œ, setIsê²Œì„_ì¢…ë£Œ] = useState(false);

  const í‘ëŒ = useColorTurnUser();

  const ë°±ëŒ = useColorTurnUser();

  const [ë°”ë‘‘íŒ, setë°”ë‘‘íŒ] = useState(createë°”ë‘‘íŒ());

  function ëŒ_ë†“ê¸°() {
    $ë†“ì„_ëŒ.current = "ê°€ì§„_ëŒ";
    $ì˜®ê¸¸_ëŒ.current = undefined;
    setë†“ì„_ìˆ˜_ìˆëŠ”_ìœ„ì¹˜(ê°€ì§„_ëŒ_ë†“ì„_ìˆ˜_ìˆëŠ”_ìœ„ì¹˜);
  }

  function ê°€ì§„_ëŒ_ë†“ê¸°(x: number, y: number) {
    let ë†“ì„_ì•Œ: "w" | "b" = ì°¨ë¡€ === "ë°±ëŒ" ? "w" : "b";

    const { isì§€ë¢° } = ë°”ë‘‘íŒ[y][x];

    if (isì§€ë¢°) ë†“ì„_ì•Œ = ì°¨ë¡€ === "ë°±ëŒ" ? "b" : "w";

    setë°”ë‘‘íŒ((ë°”ë‘‘íŒ) =>
      ë°”ë‘‘íŒ.map((í–‰, _y) =>
        í–‰.map((ì…€, _x) =>
          x === _x && y === _y
            ? {
                ...ì…€,
                ë°”ë‘‘ì•Œ: ë†“ì„_ì•Œ,
              }
            : ì…€
        )
      )
    );
    setë†“ì„_ìˆ˜_ìˆëŠ”_ìœ„ì¹˜([]);
    setì°¨ë¡€(ì°¨ë¡€ === "ë°±ëŒ" ? "í‘ëŒ" : "ë°±ëŒ");
    setë§ˆì§€ë§‰ìœ¼ë¡œ_ë†“ì¸_ëŒ_ìœ„ì¹˜([x, y]);
    if (ì°¨ë¡€ === "ë°±ëŒ") ë°±ëŒ.ë°”ë‘‘ì•Œ_ë†“ê¸°();
    else í‘ëŒ.ë°”ë‘‘ì•Œ_ë†“ê¸°();

    if (isì§€ë¢°) {
      const ë°”ë€ŒëŠ”_ì•Œ = ë†“ì„_ì•Œ === "b" ? "í‘ëŒ" : "ë°±ëŒ";
      toast(`ğŸ’£ ì§€ë¢° ë°œê²¬ : "${ì°¨ë¡€}"ì´ "${ë°”ë€ŒëŠ”_ì•Œ}"ë¡œ ë°”ë€ë‹ˆë‹¤.`);
    }
  }

  function ë†“ì¸_ëŒ_í´ë¦­(x: number, y: number) {
    $ë†“ì„_ëŒ.current = "ë†“ì¸_ëŒ";
    $ì˜®ê¸¸_ëŒ.current = [x, y];

    const ë†“ì„_ìˆ˜_ìˆëŠ”_ì£¼ë³€_ìœ„ì¹˜: Array<[number, number]> = [
      [-1, 0],
      [-1, -1],
      [0, -1],
      [1, -1],
      [1, 0],
      [1, 1],
      [0, 1],
      [-1, 1],
    ]
      .filter(([_x, _y]) => ë°”ë‘‘íŒ[y + _y]?.[x + _x]?.ë°”ë‘‘ì•Œ === null)
      .map(([_x, _y]) => [x + _x, y + _y]);

    setë†“ì„_ìˆ˜_ìˆëŠ”_ìœ„ì¹˜(ë†“ì„_ìˆ˜_ìˆëŠ”_ì£¼ë³€_ìœ„ì¹˜);
  }

  function ë†“ì¸_ëŒ_ì˜®ê¸°ê¸°(x: number, y: number) {
    if ($ì˜®ê¸¸_ëŒ.current) {
      const [_x, _y] = $ì˜®ê¸¸_ëŒ.current;

      let ì˜®ê²¨ì§ˆ_ì•Œ = ë°”ë‘‘íŒ[_y][_x].ë°”ë‘‘ì•Œ;

      const { isì§€ë¢° } = ë°”ë‘‘íŒ[y][x];

      if (isì§€ë¢°) ì˜®ê²¨ì§ˆ_ì•Œ = ì˜®ê²¨ì§ˆ_ì•Œ === "w" ? "b" : "w";

      setë°”ë‘‘íŒ((ë°”ë‘‘íŒ) =>
        ë°”ë‘‘íŒ.map((í–‰, __y) =>
          í–‰.map((ì…€, __x) =>
            // ì˜®ê²¨ì§ˆ ìœ„ì¹˜ ì°¾ê¸°
            x === __x && y === __y
              ? {
                  ...ì…€,
                  ë°”ë‘‘ì•Œ: ì˜®ê²¨ì§ˆ_ì•Œ,
                }
              : // ë¹„ì›Œì§ˆ ìœ„ì¹˜ ì°¾ê¸°
              _x === __x && _y === __y
              ? {
                  ...ì…€,
                  ë°”ë‘‘ì•Œ: null,
                }
              : ì…€
          )
        )
      );

      setë†“ì„_ìˆ˜_ìˆëŠ”_ìœ„ì¹˜([]);
      setì°¨ë¡€(ì°¨ë¡€ === "ë°±ëŒ" ? "í‘ëŒ" : "ë°±ëŒ");
      setë§ˆì§€ë§‰ìœ¼ë¡œ_ë†“ì¸_ëŒ_ìœ„ì¹˜([x, y]);

      if (isì§€ë¢°) {
        const ì˜®ê²¨ì§„_ì•Œ = ë°”ë‘‘íŒ[_y][_x].ë°”ë‘‘ì•Œ === "b" ? "í‘ëŒ" : "ë°±ëŒ";
        const ë°”ë€ŒëŠ”_ì•Œ = ì˜®ê²¨ì§ˆ_ì•Œ === "b" ? "í‘ëŒ" : "ë°±ëŒ";
        toast(`ğŸ’£ ì§€ë¢° ë°œê²¬ : "${ì˜®ê²¨ì§„_ì•Œ}"ì´ "${ë°”ë€ŒëŠ”_ì•Œ}"ë¡œ ë°”ë€ë‹ˆë‹¤.`);
      }
    }
  }

  function ê²Œì„_ì´ˆê¸°í™”() {
    $ë†“ì„_ëŒ.current = undefined;
    $ì˜®ê¸¸_ëŒ.current = undefined;

    setì°¨ë¡€("í‘ëŒ");
    setë§ˆì§€ë§‰ìœ¼ë¡œ_ë†“ì¸_ëŒ_ìœ„ì¹˜(undefined);
    setë°”ë‘‘íŒ(createë°”ë‘‘íŒ());
    ë°±ëŒ.ì•Œ_ì±„ìš°ê¸°();
    í‘ëŒ.ì•Œ_ì±„ìš°ê¸°();
    setIsê²Œì„_ì¢…ë£Œ(false);
  }

  const ê°€ì§„_ëŒ_ë†“ì„_ìˆ˜_ìˆëŠ”_ìœ„ì¹˜ = useMemo(() => {
    const y = ì°¨ë¡€ === "ë°±ëŒ" ? 0 : ë°”ë‘‘íŒ_ê¸¸ì´ - 1;

    return Array.from({ length: ë°”ë‘‘íŒ_ê¸¸ì´ })
      .map((_, x) => [x, y] as [number, number])
      .filter(([x, y]) => ë°”ë‘‘íŒ[y][x].ë°”ë‘‘ì•Œ === null);
  }, [ì°¨ë¡€, ë°”ë‘‘íŒ]);

  useEffect(() => {
    const ê²Œì„_ìŠ¹ì = getê²Œì„_ìŠ¹ì(ë°”ë‘‘íŒ);

    if (ê²Œì„_ìŠ¹ì) {
      $ê²Œì„_ìŠ¹ì.current = ê²Œì„_ìŠ¹ì;
      setIsê²Œì„_ì¢…ë£Œ(true);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [ë°”ë‘‘íŒ]);

  useEffect(() => {
    if (isê²Œì„_ì¢…ë£Œ) {
      alert(
        `ê²Œì„ ì¢…ë£Œ : [${
          $ê²Œì„_ìŠ¹ì.current! === "b" ? "í‘ëŒ" : "ë°±ëŒ"
        }] ë‹˜ì´ ìŠ¹ë¦¬í•˜ì…¨ìŠµë‹ˆë‹¤.`
      );
    }
  }, [isê²Œì„_ì¢…ë£Œ]);

  return {
    ë°”ë‘‘íŒ,
    í‘ëŒ,
    ë°±ëŒ,
    ì°¨ë¡€,
    ëŒ_ë†“ê¸°,
    ë†“ì„_ìˆ˜_ìˆëŠ”_ìœ„ì¹˜,
    ê°€ì§„_ëŒ_ë†“ê¸°,
    isê°€ì§„_ëŒ_ë†“ì„_ìˆ˜_ì—†ìŒ: ê°€ì§„_ëŒ_ë†“ì„_ìˆ˜_ìˆëŠ”_ìœ„ì¹˜.length === 0,
    ë†“ì¸_ëŒ_í´ë¦­,
    $ë†“ì„_ëŒ,
    ë†“ì¸_ëŒ_ì˜®ê¸°ê¸°,
    ë§ˆì§€ë§‰ìœ¼ë¡œ_ë†“ì¸_ëŒ_ìœ„ì¹˜,
    isê²Œì„_ì¢…ë£Œ,
    ê²Œì„_ì´ˆê¸°í™”,
  };
}

export default useColorTurn;
